<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CameraDAO">
    <select id="getAvailableCameraList" resultMap="getAvailableCameraList">
        SELECT TR.totalOfRecord, CameraId, CameraName
        FROM tblCamera,
             (SELECT COUNT(CameraId) AS totalOfRecord
             FROM tblCamera
             WHERE StatusId = 3 AND TypeDetect = #{typeDetect}) TR
        WHERE StatusId = 3 AND TypeDetect = #{typeDetect}
        ORDER BY CameraName ASC
    </select>
    <select id="getCameraList" resultMap="getCameraList">
         SELECT TR.totalOfRecord,
                C.CameraId,
                C.CameraName,
                C.ImageURL,
                C.IPAddress,
                C.TypeDetect,
                ST.StoreId,
                C.UpdatedTime,
                C.StatusId,
                STT.StatusName
         FROM tblCamera C
         JOIN tblStatus STT ON C.StatusId = STT.StatusId
         <if test="statusId != 0">
             AND STT.StatusId = #{statusId}
         </if>
         LEFT JOIN tblStackProductCameraMapping SPCM
         ON SPCM.CameraId = C.CameraId AND SPCM.StatusId = 1
         LEFT JOIN tblStack STK ON SPCM.StackId = STK.StackId AND STK.StatusId = 1
         LEFT JOIN tblShelf SH ON STK.ShelfId = SH.ShelfId AND SH.StatusId != 2
         LEFT JOIN tblStore ST ON SH.StoreId = ST.StoreId AND ST.StatusId != 2
         LEFT JOIN tblShelfCameraMapping SCM ON C.CameraId = SCM.CameraId AND SCM.StatusId = 1
         LEFT JOIN tblShelf SH2 ON SCM.ShelfId = SH2.ShelfId AND SH2.StatusId = 1
         LEFT JOIN tblStore ST2 ON ST2.StoreId = SH2.StoreId AND ST2.StatusId != 2,
            (SELECT COUNT(C.CameraId) AS totalOfRecord
             FROM tblCamera C
             JOIN tblStatus STT ON C.StatusId = STT.StatusId
             <if test="statusId != 0">
                 AND STT.StatusId = #{statusId}
             </if>
             LEFT JOIN tblStackProductCameraMapping SPCM
             ON SPCM.CameraId = C.CameraId AND SPCM.StatusId = 1
             LEFT JOIN tblStack STK ON SPCM.StackId = STK.StackId AND STK.StatusId = 1
             LEFT JOIN tblShelf SH ON STK.ShelfId = SH.ShelfId AND SH.StatusId != 2
             LEFT JOIN tblStore ST ON SH.StoreId = ST.StoreId AND ST.StatusId != 2
             LEFT JOIN tblShelfCameraMapping SCM ON C.CameraId = SCM.CameraId AND SCM.StatusId = 1
             LEFT JOIN tblShelf SH2 ON SCM.ShelfId = SH2.ShelfId AND SH2.StatusId = 1
             LEFT JOIN tblStore ST2 ON ST2.StoreId = SH2.StoreId AND ST2.StatusId != 2
             <where>
                <if test="storeId != null">
                    ST.StoreId = #{storeId}
                </if>
                <if test="cameraName != null">
                    AND C.CameraName like '%' #{cameraName} '%'
                </if>
             </where>) TR
         <where>
             <if test="storeId != null">
                 ST.StoreId = #{storeId}
             </if>
             <if test="cameraName != null">
                 AND C.CameraName like '%' #{cameraName} '%'
             </if>
         </where>
         ORDER BY C.CameraName ASC
         LIMIT #{offSet}, #{fetchNext}
    </select>
    <insert id="createCamera">
        INSERT INTO tblCamera(CameraName, ImageURL, IPAddress, RTSPString, TypeDetect, CreatedTime, StatusId)
        VALUE(#{cameraName}, #{imageURL}, #{ipAddress}, #{rtspString}, #{typeDetect}, #{createdTime}, #{statusId})
    </insert>
    <resultMap id="getAvailableCameraList" type="ResponseAvailableCameraListForm">
        <result property="totalOfRecord" column="totalOfRecord"/>
        <collection property="cameras" ofType="AvailableCameraListResponseSupporter">
            <id property="cameraId" column="CameraId"/>
            <result property="cameraName" column="CameraName"/>
        </collection>
    </resultMap>
    <resultMap id="getCameraList" type="ResponseCameraListForm">
        <result property="totalOfRecord" column="totalOfRecord"/>
        <collection property="cameras" ofType="CameraListResponseSupporter">
            <id property="cameraId" column="CameraId"/>
            <result property="cameraName" column="CameraName"/>
            <result property="imagerURL" column="ImageURL"/>
            <result property="ipAddress" column="IPAddress"/>
            <result property="storeId" column="StoreId"/>
            <result property="statusId" column="StatusId"/>
            <result property="statusName" column="StatusName"/>
        </collection>
    </resultMap>
</mapper>