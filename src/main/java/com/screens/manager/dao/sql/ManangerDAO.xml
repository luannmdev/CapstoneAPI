<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ManagerDAO">
    <select id="getManagers" resultMap="getManagers" useCache="false">
        SELECT TR.totalOfRecord AS totalOfRecord,
               U.Fullname AS FullName,
               U.Username AS UserName,
               USM.StoreId AS StoreId,
               U.UpdatedTime AS UpdatedTime,
               S.StatusName AS StatusName
        FROM tblUser U JOIN tblStatus S ON U.statusID = S.StatusId
                       JOIN tblUserStoreMapping USM ON U.UserId = USM.UserID,
            (SELECT COUNT(U.UserId) AS totalOfRecord FROM tblUser U JOIN tblStatus S ON U.statusID = S.StatusId
            JOIN tblUserStoreMapping USM ON U.UserId = USM.UserID
            <where>
                <if test="searchValue != null">
                    <if test="searchField == 'managername'">
                        U.Fullname like '%' #{searchValue} '%'
                    </if>
                    <if test="searchField != 'managername'">
                        U.Username like '%' #{searchValue} '%'
                    </if>
                </if>
                <if test="status != null">
                    UPPER(S.StatusName) = #{status}
                </if>
            </where>) TR
        <where>
            <if test="searchValue != null">
                <if test="searchField == 'managername'">
                    U.Fullname like '%' #{searchValue} '%'
                </if>
                <if test="searchField != 'managername'">
                    U.Username like '%' #{searchValue} '%'
                </if>
            </if>
            <if test="status != null">
                UPPER(S.StatusName) = #{status}
            </if>
        </where>
        ORDER BY U.Fullname
        <if test="isDesc">
            DESC
        </if>
        <if test="!isDesc">
            ASC
        </if>
        LIMIT
        #{offSet},
        #{fetchNext}
    </select>

    <select id="getManagerDetail" resultMap="getManagerDetail" useCache="false">
        SELECT
            U.UserId,
            U.Fullname,
            U.Username,
            U.ImageUrl,
            U.Gender,
            U.BirthDate,
            U.IdentifyCard,
            U.Phone,
            U.Email,
            USM.StoreId,
            U.Address,
            C.CityName,
            D.DistrictName,
            U.CreatedTime,
            U.UpdatedTime,
            U.ReasonInactive,
            S.StatusName
        FROM tblUser U
                 JOIN tblStatus S ON U.statusID = S.StatusId
                 JOIN tblUserStoreMapping USM ON U.UserId = USM.UserID
                 JOIN tblDistrict D ON D.DistrictId = U.DistrictId
                 JOIN tblCity C ON C.CityId = D.CityId
        WHERE U.userName = #{userName}
    </select>

    <resultMap id="getManagers" type="ResponseManagerListForm">
        <result property="totalOfRecord" column="totalOfRecord"/>
        <collection property="managers" ofType="ManagerResponseSupporter">
            <id property="userName" column="UserName"/>
            <result property="managerName" column="FullName"/>
            <result property="storeId" column="StoreId"/>
            <result property="updatedTime" column="UpdatedTime"/>
            <result property="status" column="StatusName"/>
        </collection>
    </resultMap>
    <resultMap id="getManagerDetail" type="ResponseManagerDetailForm">
        <result property="userId" column="UserId"/>
        <result property="fullName" column="Fullname"/>
        <result property="userName" column="Username"/>
        <result property="imageURL" column="ImageUrl"/>
        <result property="isMale" column="Gender"/>
        <result property="birthDate" column="BirthDate"/>
        <result property="identifyCard" column="IdentifyCard"/>
        <result property="phone" column="Phone"/>
        <result property="email" column="Email"/>
        <result property="storeId" column="StoreId"/>
        <result property="address" column="Address"/>
        <result property="cityName" column="CityName"/>
        <result property="districtName" column="DistrictName"/>
        <result property="createdTime" column="CreatedTime"/>
        <result property="updatedTime" column="UpdatedTime"/>
        <result property="reasonInactive" column="ReasonInactive"/>
        <result property="status" column="StatusName"/>
    </resultMap>
</mapper>