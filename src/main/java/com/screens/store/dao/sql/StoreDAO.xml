<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.screens.store.dao.sql.StoreDAO">

    <select id="getStoreList" resultMap="getStoreList">
        SELECT
            SUPQUE.totalOfRecord,
            S.StoreName,
            S.ImageURL,
            CONCAT_WS(', ',S.Address, TD.DistrictName, TC.CityName) AS Address,
            TU.Username,
            S.UpdatedTime,
            TS.StatusName
        FROM tblStore S
                LEFT JOIN tblUserStoreMapping TUSM ON (S.StoreId = TUSM.StoreId AND TUSM.StatusId = 1)
                LEFT JOIN tblUser TU ON (TUSM.UserId = TU.UserId)
                LEFT JOIN tblStatus TS ON (S.StatusId = TS.StatusId)
                LEFT JOIN tblDistrict TD ON (S.DistrictId = TD.DistrictId)
                LEFT JOIN tblCity TC ON (TD.CityId = TC.CityId),
            (SELECT COUNT(*) AS totalOfRecord
            FROM tblStore S
                LEFT JOIN tblUserStoreMapping TUSM ON (S.StoreId = TUSM.StoreId AND TUSM.StatusId = 1)
                LEFT JOIN tblUser TU ON (TUSM.UserId = TU.UserId)
                LEFT JOIN tblStatus TS ON (S.StatusId = TS.StatusId)
                LEFT JOIN tblDistrict TD ON (S.DistrictId = TD.DistrictId)
                LEFT JOIN tblCity TC ON (TD.CityId = TC.CityId)
            <where>
                <if test="searchValue != null">
                    <choose>
                        <when test="searchField == 'storename'">
                            S.StoreName LIKE '%' #{searchValue} '%'
                        </when>
                        <when test="searchField == 'city'">
                            TC.CityName LIKE '%' #{searchValue} '%'
                        </when>
                        <when test="searchField == 'district'">
                            TD.DistrictName LIKE '%' #{searchValue} '%'
                        </when>
                        <when test="searchField == 'manager'">
                            TU.Username LIKE '%' #{searchValue} '%'
                        </when>
                    </choose>
                </if>
            </where>
                 ) AS SUPQUE
        <where>
            <if test="searchValue != null">
                <choose>
                    <when test="searchField == 'storename'">
                        S.StoreName LIKE '%' #{searchValue} '%'
                    </when>
                    <when test="searchField == 'city'">
                        TC.CityName LIKE '%' #{searchValue} '%'
                    </when>
                    <when test="searchField == 'district'">
                        TD.DistrictName LIKE '%' #{searchValue} '%'
                    </when>
                    <when test="searchField == 'manager'">
                        TU.Username LIKE '%' #{searchValue} '%'
                    </when>
                </choose>
            </if>
        </where>
    </select>

    <resultMap id="getStoreList" type="ResponseStoreListForm">
        <result property="totalOfRecord" column="totalOfRecord"/>
        <collection property="stores" ofType="StoreResponseSupporter">
            <id property="storeName" column="StoreName"/>
            <result property="imageURL" column="ImageURL"/>
            <result property="managerUsername" column="Username"/>
            <result property="address" column="Address"/>
            <result property="lastUpdated" column="UpdatedTime"/>
            <result property="status" column="StatusName"/>
        </collection>
    </resultMap>

</mapper>